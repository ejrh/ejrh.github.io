---
layout: post
title: Schema diagrams for PostgreSQL
date: 2012-08-29 20:36:49.000000000 +12:00
categories:
- Programming
tags:
- database
- graphviz
- postgresql
- python
- yed
status: publish
type: post
published: true
meta:
  _edit_last: '14086420'
  tagazine-media: a:7:{s:7:"primary";s:58:"http://ejrh.files.wordpress.com/2012/08/filesys-schema.png";s:6:"images";a:1:{s:58:"http://ejrh.files.wordpress.com/2012/08/filesys-schema.png";a:6:{s:8:"file_url";s:58:"http://ejrh.files.wordpress.com/2012/08/filesys-schema.png";s:5:"width";i:1434;s:6:"height";i:762;s:4:"type";s:5:"image";s:4:"area";i:1092708;s:9:"file_path";b:0;}}s:6:"videos";a:0:{}s:11:"image_count";i:1;s:6:"author";s:8:"14086420";s:7:"blog_id";s:8:"19263352";s:9:"mod_stamp";s:19:"2012-08-29
    08:36:49";}
  _wpas_skip_google_plus: '1'
  _wpas_skip_twitter: '1'
  _wpas_skip_tumblr: '1'
  _wpas_skip_path: '1'
author: 
---
<p style="text-align:justify;">I have made some progress towards the longstanding goal of drawing nice diagrams of database schemas. Firstly, I've figured out how to use <a title="yEd home page" href="http://www.yworks.com/en/products_yed_about.html">yEd</a>'s Entity Relationship node types as table nodes. These special node types have both a node label, and an additional content field. The additional field is normally free text but can also contain HTML data (akin to <a title="GraphViz home page" href="http://www.graphviz.org/">GraphViz</a>'s support for HTML nodes).</p>
<p style="text-align:justify;">So a database table can be drawn with its name in the label, and a list of fields in the node body. And, with HTML mode, that list can be a table with columns for name, type, PK/FK status, etc.</p>
<p style="text-align:justify;">But yEd has not quite caught up with GraphViz. In GraphViz, cells in an HTML table can be identified with ports, and an edge drawn between nodes can then target specific ports in each. yEd only supports a handful of predefined ports per shape (the centre, each side, and each corner). Furthermore, its automatic layout algorithms ignore the port data, and draw edges to the nearest part of a node. Still, those layout algorithms are the great strength of yEd and flexibility vs layout is a reasonable tradeoff.</p>
<p style="text-align:justify;">Since entering the HTML contents by hand is time-consuming and prone to error, I've written a quick program to do it. The program, pgschemagraph.py, is run against a live <a title="PostgreSQL home page" href="http://www.postgresql.org/">PostgreSQL</a> database. It will examine the table and foreign key definitions in the given schemas, and generate a GraphML representation of them.</p>
<p style="text-align:justify;">Here is an example, taken from my "filesys" database:</p>
<p>[caption id="attachment_2328" align="aligncenter" width="640"]<a href="http://ejrh.files.wordpress.com/2012/08/filesys-schema.png"><img class="size-full wp-image-2328" title="filesys-schema" src="assets/filesys-schema.png" alt="" width="640" height="340" /></a> Schema for the "filesys" database, generated by pgschemagraph.py.[/caption]</p>
<p style="text-align:justify;">The complete steps to create this diagram are:</p>
<ol style="text-align:justify;">
<li><code>pgschemagraph.py -h localhost -d filesys -u edmund -p ***** -s public &gt; filesys-schema.graphml</code></li>
<li>Open <code>filesys-schema.graphml</code> in yEd.</li>
<li>Run Orthogonal Layout with default settings (Alt-Shift-O, Enter).</li>
</ol>
<p style="text-align:justify;">As you can see, pgschemagraph.py has found the tables, their fields and types (including standard SQL types, user defined types like "cube", and domains like "imageid"), the primary keys (indicated by underscoring) and whether they can be NULL (indicated by italics). It has also discovered the foreign key relations between tables.</p>
<p style="text-align:justify;">Because the program works in terms of abstract database definitions, rather than nicely drawn diagrams, it does not do much layout. When first loaded in yEd, this file will show the tables stacked atop one another. The most pgschemagraph.py can do is guess the height of each node based on the number of rows in it (based on a heuristic of 22 points per line in the default font; it can't do the width, because it does not know how wide each character is).</p>
<p style="text-align:justify;">But it does perform about 80% of the work required to draw a good diagram. A human can easily and quickly do the rest.</p>
<p style="text-align:justify;">At present it uses the standard <code>information_schema</code> catalog rather than the PostgreSQL-specific <code>pg_catalog</code>. The aim was that this would make it easier to port to other systems that support <code>information_schema</code>. The downsides are that <code>information_schema</code> is actually slightly difficult to use (since it's very generic), and does not provide some useful information such as inheritence and partition relationships. In some of my schemas, tables are partitioned into multiple subtables. It would be nice to that represented in the diagram, rather than have the subtables floating around unconnected. So a rewrite to use <code>pg_catalog</code> may be in order. (Porting to alternative systems will then require a more system-specific approach).</p>
<p style="text-align:justify;">More information can always be shown on the diagram. One idea is to allow different colours to be used. This could be done by schema, or by grouping of tables.</p>
<p style="text-align:justify;">It would be possible to have the program run yEd's layout engine directly.  Sadly, yEd is proprietary software, and however much I appreciate its help in laying out my diagrams, I'm averse to depending on it directly.  Generating the standard GraphML output (and potentially .dot output, for GraphViz), and running the program myself is a reasonable compromise.</p>
<p style="text-align:justify;">The program, pgpgschemagraph.py, is <a title="ejrh/db-tools on Github" href="https://github.com/ejrh/db-tools">on Github</a>.</p>
